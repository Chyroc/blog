<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-cn lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>defer 与 return 的问题（defer 之一） &#183; Chyroc的博客</title><meta name=description content><link type=text/css rel=stylesheet href=https://chyroc.cn/css/print.css media=print><link type=text/css rel=stylesheet href=https://chyroc.cn/css/poole.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/syntax.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chyroc.cn><h1>Chyroc的博客</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chyroc.cn>Home</a></li><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul></nav></div></aside><main class="content container"><div class=post><h1>defer 与 return 的问题（defer 之一）</h1><time datetime=2018-01-25T08:00:00+0800 class=post-date>2018-01-25 08:00:00</time><p>我们知道 defer 的时候会将后面的函数入栈，然后 return 的时候执行。</p><p>那么具体是什么样子的呢。</p><p>分 4 步：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>- 遇到defer函数，计算defer函数的参数值，入栈
- 将return后面的值计算出来，赋给t（这个t是函数声明中要返回的的变量）
- 执行defer函数
- 空的return（结果就是那个t）
</code></pre></div><h2 id=关于-defer-函数的参数什么时候计算>关于 defer 函数的参数什么时候计算</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()) <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()) <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>}
</code></pre></div><p>先 print 的时间(line 3)是要比后 print 的时间(line 1)多 1s 的，所以是先计算 defer 的参数，入栈，然后再继续往下执行</p><h2 id=关于-return-后面的参数与-defer-函数之间的关系>关于 return 后面的参数与 defer 函数之间的关系</h2><p><strong>最重要的一点就是要明白，return xxx 这一条语句并不是一条原子指令!</strong></p><p>下面这段代码给了三个使用了 defer 的函数<code>f_x()</code>，然后将其分解开了，写成了<code>g_x()</code>，希望通过这个分解让你对 defer 更加了解。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;sync&#34;</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>f1</span>() (<span style=color:#a6e22e>result</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
		<span style=color:#a6e22e>result</span><span style=color:#f92672>++</span>
	}()
	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>g1</span>() (<span style=color:#a6e22e>result</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>result</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>result</span><span style=color:#f92672>++</span>   <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span>     <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>f2</span>() (<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5</span>
	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
		<span style=color:#a6e22e>t</span> = <span style=color:#a6e22e>t</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>
	}()
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>g2</span>() (<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5</span>

	<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>t</span>     <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span> = <span style=color:#a6e22e>t</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span> <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span>    <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>f3</span>() (<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) {
		<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>r</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>
	}(<span style=color:#a6e22e>r</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>g3</span>() (<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>r</span> = <span style=color:#ae81ff>1</span>                                     <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}                  <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)                                  <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) { <span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>r</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>; <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Done</span>() }(<span style=color:#a6e22e>r</span>) <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Wait</span>()                                  <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span>                                    <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	println(<span style=color:#a6e22e>f1</span>(), <span style=color:#a6e22e>f1</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>g1</span>())
	println(<span style=color:#a6e22e>f2</span>(), <span style=color:#a6e22e>f2</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>g2</span>())
	println(<span style=color:#a6e22e>f3</span>(), <span style=color:#a6e22e>f3</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>g3</span>())
}
</code></pre></div><p>结果是</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>1 true
5 true
1 true
</code></pre></div><h2 id=参考>参考</h2><ul><li><a href=https://github.com/goquiz/goquiz.github.io>https://github.com/goquiz/goquiz.github.io</a></li><li><a href=https://github.com/tiancaiamao/go-internals/blob/master/zh/03.4.md>https://github.com/tiancaiamao/go-internals/blob/master/zh/03.4.md</a></li></ul></div><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>© <a href=https://chyroc.cn>chyroc</a> <a href=https://github.com/spf13/hyde>Theme By hyde</a> 2020
<span id=reading-statistics><span><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'defer-return',title:'defer 与 return 的问题（defer 之一）',owner:'chyroc',repo:'blog',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></main></body></html>