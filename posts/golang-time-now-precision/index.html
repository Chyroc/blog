<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-cn lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>golang 的 time.Now 精度 &#183; Chyroc的博客</title><meta name=description content><link type=text/css rel=stylesheet href=https://chyroc.cn/css/print.css media=print><link type=text/css rel=stylesheet href=https://chyroc.cn/css/poole.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/syntax.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chyroc.cn><h1>Chyroc的博客</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chyroc.cn>Home</a></li><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul></nav></div></aside><main class="content container"><div class=post><h1>golang 的 time.Now 精度</h1><time datetime=2019-03-03T14:08:25+0800 class=post-date>2019-03-03 14:08:25</time><p>昨天群里有人问了一个问题</p><blockquote><p>golang defer 函数参数是什么时候求值的哈， 我这边试了下输出有时候两者是一样的，有时候两者相差 1000ms</p></blockquote><p><img src=https://media.chyroc.cn/img/1a908e73-5b1f-4bed-a676-097a4370ef9f.png alt></p><p>这里面的 defer 的参数计算问题可以在<a href=https://chyroc.cn/posts/defer-return/>这篇文章</a>中找到</p><p>本文主要讨论 <code>time.Now</code> 函数的精度问题。</p><p>先看一下下面这段代码</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>test</span>() {
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()                                              <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Print</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Nanosecond</span>()<span style=color:#f92672>-</span><span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>Nanosecond</span>(), <span style=color:#e6db74>&#34;,&#34;</span>) <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1000</span>)                                                 <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>()
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>test2</span>() {
	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>() <span style=color:#75715e>//4
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>N</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1000</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>() <span style=color:#75715e>// 5
</span><span style=color:#75715e></span>	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>()
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>((<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Nanosecond</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Nanosecond</span>()) <span style=color:#f92672>/</span> (<span style=color:#a6e22e>N</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)) <span style=color:#75715e>// 6
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>test</span>()
	<span style=color:#a6e22e>test2</span>()
}
</code></pre></div><p><code>test</code> 函数就是截图里面那位朋友的代码。</p><p>首先，<code>line 2</code> 肯定是先计算 <code>time.Now()</code>，然后再将参数入栈的，现在的问题是：这样的代码的结果应该是固定的，为什么有时候返回 <code>0ns</code>，有时候返回 <code>1000ns</code>？</p><p>我看到这段代码后，想到的第一个原因就是 <code>time.Now</code> 这个函数的执行时间导致的上面的问题，但是仔细一想：如果是这样的话，name 应该每次相差的结果（<code>line 2</code> print 的）应该差不多呀，为什么大部分是 0，少部分是 1000 呢？而且为什么是 1000，不是 2000 呢？</p><p>然后我就翻了一下 <code>go</code> 的 <code>time.Now</code> 的源码：</p><ul><li><a href=https://github.com/golang/go/blob/master/src/runtime/timestub.go#L15-L18>timestub.go</a></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>//go:linkname time_now time.now
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>time_now</span>() (<span style=color:#a6e22e>sec</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>nsec</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>mono</span> <span style=color:#66d9ef>int64</span>) {
	<span style=color:#a6e22e>sec</span>, <span style=color:#a6e22e>nsec</span> = <span style=color:#a6e22e>walltime</span>()
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sec</span>, <span style=color:#a6e22e>nsec</span>, <span style=color:#a6e22e>nanotime</span>()
}
</code></pre></div><ul><li><a href=https://github.com/golang/go/blob/master/src/runtime/sys_darwin.go#L248-L252>sys_darwin.go</a></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>//go:nosplit
</span><span style=color:#75715e>//go:cgo_unsafe_args
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>walltime</span>() (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>int32</span>) {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t</span> <span style=color:#a6e22e>timeval</span>
	<span style=color:#a6e22e>libcCall</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>funcPC</span>(<span style=color:#a6e22e>walltime_trampoline</span>)), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>))
	<span style=color:#66d9ef>return</span> int64(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>tv_sec</span>), <span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>tv_usec</span>  <span style=color:#75715e>// line 7
</span><span style=color:#75715e></span>}
</code></pre></div><p>[捂脸]根据 <code>line 7</code>，在 <code>darwin(mac)</code> 系统上，go 的 <code>time.Now</code> 精度就是 1000ns。</p><p>所以在上面 <code>line 2</code> 的代码中，每个 <code>time.Now</code> 都是 80 - 150 ns 的时间，然后 print 0，到 1000 ns 过去后，就 print 一个 1000 ns</p><p>将上面的代码交叉编译并在 linux 系统上执行，结果是：</p><p><img src=https://media.chyroc.cn/img/de10cb13-6439-4225-873c-2c2fa0dc3239.png alt></p><p>嗯&mldr;是正常的了。</p></div><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>© <a href=https://chyroc.cn>chyroc</a> <a href=https://github.com/spf13/hyde>Theme By hyde</a> 2020
<span id=reading-statistics><span><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'golang-time-now-precision',title:'golang 的 time.Now 精度',owner:'chyroc',repo:'blog',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></main></body></html>