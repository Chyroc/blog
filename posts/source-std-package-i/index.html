<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-cn lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>go 的标准库阅读 &#183; Chyroc的博客</title><meta name=description content><link type=text/css rel=stylesheet href=https://chyroc.cn/css/print.css media=print><link type=text/css rel=stylesheet href=https://chyroc.cn/css/poole.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/syntax.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chyroc.cn><h1>Chyroc的博客</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chyroc.cn>Home</a></li><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul></nav></div></aside><main class="content container"><div class=post><h1>go 的标准库阅读</h1><time datetime=2018-03-28T08:00:00+0800 class=post-date>2018-03-28 08:00:00</time><p>本文中讲的是<code>fmt</code>包</p><p>先看<code>fmt.Fprintf</code>，这个函数将格式化字符串，并写入到 w 中</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newPrinter</span>()
	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>doPrintf</span>(<span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>a</span>)
	<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>)
	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>free</span>()
	<span style=color:#66d9ef>return</span>
}
</code></pre></div><p>然后看一下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// newPrinter allocates a new pp struct or grabs a cached one.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newPrinter</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>pp</span> {
	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ppFree</span>.<span style=color:#a6e22e>Get</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>pp</span>)
	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>panicking</span> = <span style=color:#66d9ef>false</span>
	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>erroring</span> = <span style=color:#66d9ef>false</span>
	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>init</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// 这里用到了`sync.Pool`（`sync.Pool`是一个伪的内存池，作用就是减少alloc）来分配pp结构
</span><span style=color:#75715e>// 用法
</span><span style=color:#75715e>//   1. 定义New函数
</span><span style=color:#75715e>//   2. p := ppFree.Get().(*pp)
</span><span style=color:#75715e>//   3. ppFree.Put(p)
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ppFree</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Pool</span>{
	<span style=color:#a6e22e>New</span>: <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>interface</span>{} { <span style=color:#66d9ef>return</span> new(<span style=color:#a6e22e>pp</span>) },
}
</code></pre></div><p>pp 是什么样子的呢</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// 存储printer的状态
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pp</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>buf</span> <span style=color:#a6e22e>buffer</span> <span style=color:#75715e>// 数据
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// arg holds the current item, as an interface{}.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>arg</span> <span style=color:#66d9ef>interface</span>{} <span style=color:#75715e>// 当前的item
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// value is used instead of arg for reflect values.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>value</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span> <span style=color:#75715e>// 反射的时候，等同于arg
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// fmt is used to format basic items such as integers or strings.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span> <span style=color:#a6e22e>fmt</span> <span style=color:#75715e>// 格式化基本item：数字/字符串
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// reordered records whether the format string used argument reordering.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>reordered</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 标识format字符串是否使用了argument reordering
</span><span style=color:#75715e></span>	<span style=color:#75715e>// goodArgNum records whether the most recent reordering directive was valid.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>goodArgNum</span> <span style=color:#66d9ef>bool</span>
	<span style=color:#75715e>// panicking is set by catchPanic to avoid infinite panic, recover, panic, ... recursion.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>panicking</span> <span style=color:#66d9ef>bool</span>
	<span style=color:#75715e>// erroring is set when printing an error string to guard against calling handleMethods.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>erroring</span> <span style=color:#66d9ef>bool</span>
}
</code></pre></div><p>fmt 是什么样子的呢</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// A fmt is the raw formatter used by Printf etc.
</span><span style=color:#75715e>// It prints into a buffer that must be set up separately.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>fmt</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>buffer</span>

	<span style=color:#a6e22e>fmtFlags</span>

	<span style=color:#a6e22e>wid</span>  <span style=color:#66d9ef>int</span> <span style=color:#75715e>// width
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>prec</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// precision
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// intbuf is large enough to store %b of an int64 with a sign and
</span><span style=color:#75715e></span>	<span style=color:#75715e>// avoids padding at the end of the struct on 32 bit architectures.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>intbuf</span> [<span style=color:#ae81ff>68</span>]<span style=color:#66d9ef>byte</span>
}
</code></pre></div><p><code>p.doPrintf(format, a)</code>做了格式化的主要工作</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pp</span>) <span style=color:#a6e22e>doPrintf</span>(<span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> []<span style=color:#66d9ef>interface</span>{}) {
	<span style=color:#a6e22e>end</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>format</span>)
	<span style=color:#a6e22e>argNum</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>         <span style=color:#75715e>// we process one argument per non-trivial format
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>afterIndex</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>// previous item in format was an index like [3].
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>reordered</span> = <span style=color:#66d9ef>false</span>
<span style=color:#a6e22e>formatLoop</span>:
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>end</span>; {
		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>goodArgNum</span> = <span style=color:#66d9ef>true</span>
		<span style=color:#a6e22e>lasti</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>
		<span style=color:#75715e>// 跳过所有的百分号%
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>end</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;%&#39;</span> {
			<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
		}
		<span style=color:#75715e>// 将上面跳过的字符（没有%）直接放到buf中
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &gt; <span style=color:#a6e22e>lasti</span> {
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>lasti</span>:<span style=color:#a6e22e>i</span>])
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>end</span> {
			<span style=color:#75715e>// done processing format string
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>break</span>
		}

		<span style=color:#75715e>// Process one verb
</span><span style=color:#75715e></span>		<span style=color:#75715e>// 加1，这个时候i就指向%后面那个字符了
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>

		<span style=color:#75715e>// Do we have flags?
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>clearflags</span>()
	<span style=color:#a6e22e>simpleFormat</span>:
		<span style=color:#66d9ef>for</span> ; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>end</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
			<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>]
			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>c</span> {
			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;#&#39;</span>:
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharp</span> = <span style=color:#66d9ef>true</span>
			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;0&#39;</span>:
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>zero</span> = !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>minus</span> <span style=color:#75715e>// Only allow zero padding to the left.
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;+&#39;</span>:
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plus</span> = <span style=color:#66d9ef>true</span>
			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;-&#39;</span>:
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>minus</span> = <span style=color:#66d9ef>true</span>
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>zero</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>// Do not pad with zeros to the right.
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39; &#39;</span>:
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>space</span> = <span style=color:#66d9ef>true</span>
			<span style=color:#66d9ef>default</span>:
				<span style=color:#75715e>// Fast path for common case of ascii lower case simple verbs
</span><span style=color:#75715e></span>				<span style=color:#75715e>// without precision or width or argument indices.
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;z&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>argNum</span> &lt; len(<span style=color:#a6e22e>a</span>) {
					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;v&#39;</span> {
						<span style=color:#75715e>// Go syntax
</span><span style=color:#75715e></span>						<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharpV</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharp</span>
						<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharp</span> = <span style=color:#66d9ef>false</span>
						<span style=color:#75715e>// Struct-field syntax
</span><span style=color:#75715e></span>						<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plusV</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plus</span>
						<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plus</span> = <span style=color:#66d9ef>false</span>
					}
					<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>printArg</span>(<span style=color:#a6e22e>a</span>[<span style=color:#a6e22e>argNum</span>], rune(<span style=color:#a6e22e>c</span>))
					<span style=color:#a6e22e>argNum</span><span style=color:#f92672>++</span>
					<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
					<span style=color:#66d9ef>continue</span> <span style=color:#a6e22e>formatLoop</span>
				}
				<span style=color:#75715e>// Format is more complex than simple flags and a verb or is malformed.
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>break</span> <span style=color:#a6e22e>simpleFormat</span>
			}
		}

		<span style=color:#75715e>// Do we have an explicit argument index?
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>argNum</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>afterIndex</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>argNumber</span>(<span style=color:#a6e22e>argNum</span>, <span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>i</span>, len(<span style=color:#a6e22e>a</span>))

		<span style=color:#75715e>// Do we have width?
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>end</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;*&#39;</span> {
			<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>wid</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>widPresent</span>, <span style=color:#a6e22e>argNum</span> = <span style=color:#a6e22e>intFromArg</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>argNum</span>)

			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>widPresent</span> {
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>badWidthString</span>)
			}

			<span style=color:#75715e>// We have a negative width, so take its value and ensure
</span><span style=color:#75715e></span>			<span style=color:#75715e>// that the minus flag is set
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>wid</span> &lt; <span style=color:#ae81ff>0</span> {
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>wid</span> = <span style=color:#f92672>-</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>wid</span>
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>minus</span> = <span style=color:#66d9ef>true</span>
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>zero</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>// Do not pad with zeros to the right.
</span><span style=color:#75715e></span>			}
			<span style=color:#a6e22e>afterIndex</span> = <span style=color:#66d9ef>false</span>
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>wid</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>widPresent</span>, <span style=color:#a6e22e>i</span> = <span style=color:#a6e22e>parsenum</span>(<span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>end</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>afterIndex</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>widPresent</span> { <span style=color:#75715e>// &#34;%[3]2d&#34;
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>goodArgNum</span> = <span style=color:#66d9ef>false</span>
			}
		}

		<span style=color:#75715e>// Do we have precision?
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> &lt; <span style=color:#a6e22e>end</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span> {
			<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>afterIndex</span> { <span style=color:#75715e>// &#34;%[3].2d&#34;
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>goodArgNum</span> = <span style=color:#66d9ef>false</span>
			}
			<span style=color:#a6e22e>argNum</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>afterIndex</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>argNumber</span>(<span style=color:#a6e22e>argNum</span>, <span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>i</span>, len(<span style=color:#a6e22e>a</span>))
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>end</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;*&#39;</span> {
				<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>prec</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>precPresent</span>, <span style=color:#a6e22e>argNum</span> = <span style=color:#a6e22e>intFromArg</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>argNum</span>)
				<span style=color:#75715e>// Negative precision arguments don&#39;t make sense
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>prec</span> &lt; <span style=color:#ae81ff>0</span> {
					<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>prec</span> = <span style=color:#ae81ff>0</span>
					<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>precPresent</span> = <span style=color:#66d9ef>false</span>
				}
				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>precPresent</span> {
					<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>badPrecString</span>)
				}
				<span style=color:#a6e22e>afterIndex</span> = <span style=color:#66d9ef>false</span>
			} <span style=color:#66d9ef>else</span> {
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>prec</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>precPresent</span>, <span style=color:#a6e22e>i</span> = <span style=color:#a6e22e>parsenum</span>(<span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>end</span>)
				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>precPresent</span> {
					<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>prec</span> = <span style=color:#ae81ff>0</span>
					<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>precPresent</span> = <span style=color:#66d9ef>true</span>
				}
			}
		}

		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>afterIndex</span> {
			<span style=color:#a6e22e>argNum</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>afterIndex</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>argNumber</span>(<span style=color:#a6e22e>argNum</span>, <span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>i</span>, len(<span style=color:#a6e22e>a</span>))
		}

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>end</span> {
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>noVerbString</span>)
			<span style=color:#66d9ef>break</span>
		}

		<span style=color:#a6e22e>verb</span>, <span style=color:#a6e22e>size</span> <span style=color:#f92672>:=</span> rune(<span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>]), <span style=color:#ae81ff>1</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>verb</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>utf8</span>.<span style=color:#a6e22e>RuneSelf</span> {
			<span style=color:#a6e22e>verb</span>, <span style=color:#a6e22e>size</span> = <span style=color:#a6e22e>utf8</span>.<span style=color:#a6e22e>DecodeRuneInString</span>(<span style=color:#a6e22e>format</span>[<span style=color:#a6e22e>i</span>:])
		}
		<span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>size</span>

		<span style=color:#66d9ef>switch</span> {
		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>verb</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;%&#39;</span>: <span style=color:#75715e>// Percent does not absorb operands and ignores f.wid and f.prec.
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteByte</span>(<span style=color:#e6db74>&#39;%&#39;</span>)
		<span style=color:#66d9ef>case</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>goodArgNum</span>:
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>badArgNum</span>(<span style=color:#a6e22e>verb</span>)
		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>argNum</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>a</span>): <span style=color:#75715e>// No argument left over to print for the current verb.
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>missingArg</span>(<span style=color:#a6e22e>verb</span>)
		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>verb</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;v&#39;</span>:
			<span style=color:#75715e>// Go syntax
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharpV</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharp</span>
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>sharp</span> = <span style=color:#66d9ef>false</span>
			<span style=color:#75715e>// Struct-field syntax
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plusV</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plus</span>
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>plus</span> = <span style=color:#66d9ef>false</span>
			<span style=color:#66d9ef>fallthrough</span>
		<span style=color:#66d9ef>default</span>:
			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>printArg</span>(<span style=color:#a6e22e>a</span>[<span style=color:#a6e22e>argNum</span>], <span style=color:#a6e22e>verb</span>)
			<span style=color:#a6e22e>argNum</span><span style=color:#f92672>++</span>
		}
	}

	<span style=color:#75715e>// Check for extra arguments unless the call accessed the arguments
</span><span style=color:#75715e></span>	<span style=color:#75715e>// out of order, in which case it&#39;s too expensive to detect if they&#39;ve all
</span><span style=color:#75715e></span>	<span style=color:#75715e>// been used and arguably OK if they&#39;re not.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>reordered</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>argNum</span> &lt; len(<span style=color:#a6e22e>a</span>) {
		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>clearflags</span>()
		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>extraString</span>)
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>arg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>a</span>[<span style=color:#a6e22e>argNum</span>:] {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &gt; <span style=color:#ae81ff>0</span> {
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>commaSpaceString</span>)
			}
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>arg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>nilAngleString</span>)
			} <span style=color:#66d9ef>else</span> {
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#a6e22e>arg</span>).<span style=color:#a6e22e>String</span>())
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteByte</span>(<span style=color:#e6db74>&#39;=&#39;</span>)
				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>printArg</span>(<span style=color:#a6e22e>arg</span>, <span style=color:#e6db74>&#39;v&#39;</span>)
			}
		}
		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteByte</span>(<span style=color:#e6db74>&#39;)&#39;</span>)
	}
}

</code></pre></div></div><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>© <a href=https://chyroc.cn>chyroc</a> <a href=https://github.com/spf13/hyde>Theme By hyde</a> 2020
<span id=reading-statistics><span><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'source-std-package-i',title:'go 的标准库阅读',owner:'chyroc',repo:'blog',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></main></body></html>