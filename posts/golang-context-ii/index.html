<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-cn lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>Golang 中的 context 之控制（二） &#183; Chyroc的博客</title><meta name=description content><link type=text/css rel=stylesheet href=https://chyroc.cn/css/print.css media=print><link type=text/css rel=stylesheet href=https://chyroc.cn/css/poole.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/syntax.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chyroc.cn><h1>Chyroc的博客</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chyroc.cn>Home</a></li><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul></nav></div></aside><main class="content container"><div class=post><h1>Golang 中的 context 之控制（二）</h1><time datetime=2018-05-04T08:00:00+0800 class=post-date>2018-05-04 08:00:00</time><h2 id=怎么使用-context-控制-goroutine-的-cancel-的>怎么使用 context 控制 goroutine 的 cancel 的</h2><p>是如何实现流程控制的</p><p>context 包除了上面介绍的 k-v 数据对外，还有三个函数，分别是：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>
<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithDeadline</span>
<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>
</code></pre></div><p>这三个函数都会返回一个类型为<code>CancelFunc</code>的函数，通过源码可以知道，这几个函数里面返回的 cancel 分别是</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// context.WithCancel
</span><span style=color:#75715e>// c是cancelCtx
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>) }

<span style=color:#75715e>// context.WithDeadline
</span><span style=color:#75715e>// c是timerCtx
</span><span style=color:#75715e></span><span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>parent</span>)
<span style=color:#75715e>// or
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>) }

<span style=color:#75715e>// context.WithTimeout
</span><span style=color:#75715e></span><span style=color:#a6e22e>WithDeadline</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>timeout</span>))
</code></pre></div><p>从这里可以看出来，这三个函数的 cancel 是通过两个结构<code>cancelCtx</code>和<code>timerCtx</code>实现的</p><p>cancelCtx:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>cancelCtx</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>Context</span>

    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>            <span style=color:#75715e>// protects following fields
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>done</span>     <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}         <span style=color:#75715e>// created lazily, closed by first cancel call
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>children</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>canceler</span>]<span style=color:#66d9ef>struct</span>{} <span style=color:#75715e>// set to nil by the first cancel call
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span>      <span style=color:#66d9ef>error</span>                 <span style=color:#75715e>// set to non-nil by the first cancel call
</span><span style=color:#75715e></span>}
</code></pre></div><p>timerCtx:(依赖了 cancelCtx)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>timerCtx</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>cancelCtx</span>
    <span style=color:#a6e22e>timer</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Timer</span> <span style=color:#75715e>// Under cancelCtx.mu.
</span><span style=color:#75715e></span>
    <span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
}
</code></pre></div><h3 id=那先看看-cancelctx-是如何实现-cancel-的>那先看看 cancelCtx 是如何实现 cancel 的</h3><h4 id=cancelctx-源码分析>cancelCtx 源码分析</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// 实现了canceler接口
</span><span style=color:#75715e>// 可以被cancel，如果他被cancel，那么所有的children都会被cancel
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>cancelCtx</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>Context</span>

    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>            <span style=color:#75715e>// protects following fields
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>done</span>     <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}         <span style=color:#75715e>// created lazily, closed by first cancel call
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>children</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>canceler</span>]<span style=color:#66d9ef>struct</span>{} <span style=color:#75715e>// set to nil by the first cancel call
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span>      <span style=color:#66d9ef>error</span>                 <span style=color:#75715e>// set to non-nil by the first cancel call
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newCancelCtx</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>cancelCtx</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cancelCtx</span>{<span style=color:#a6e22e>Context</span>: <span style=color:#a6e22e>parent</span>}
}

<span style=color:#75715e>// 返回一个阻塞的chan，并且赋给c.done
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>Done</span>() <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{} {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
    }
    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>
}

<span style=color:#75715e>// 返回cancelCtx中的err
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>Err</span>() <span style=color:#66d9ef>error</span> {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v.WithCancel&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>)
}

<span style=color:#75715e>// cancel函数
</span><span style=color:#75715e>// 关闭c.done这个阻塞chan，以及任何children的c.done
</span><span style=color:#75715e>// 如果removeFromParent==true，将当前ctx和parent之间的链移除，即当前ctx不再是parent的child
</span><span style=color:#75715e>// err 可以是context.Canceled，也可以是context.DeadlineExceeded
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>) <span style=color:#a6e22e>cancel</span>(<span style=color:#a6e22e>removeFromParent</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        panic(<span style=color:#e6db74>&#34;context: internal error: missing cancel error&#34;</span>)
    }
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
        <span style=color:#75715e>// err只有这个函数可以设置，所以如果err已经!=nil了，那么就已经cancel了
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#75715e>// already canceled
</span><span style=color:#75715e></span>    }
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>err</span>

    <span style=color:#75715e>// 接下来5行将c.done设置为一个已经close的chan
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 所以c.Done不再阻塞了
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span> = <span style=color:#a6e22e>closedchan</span>
    } <span style=color:#66d9ef>else</span> {
        close(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>done</span>)
    }

    <span style=color:#75715e>// 循环cancel所有的children
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>children</span> {
        <span style=color:#75715e>// NOTE: acquiring the child&#39;s lock while holding parent&#39;s lock.
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>)
    }
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>children</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()

    <span style=color:#75715e>// 如果有需要，移除与parent的链
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>removeFromParent</span> {
        <span style=color:#a6e22e>removeChild</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>c</span>)
    }
}
</code></pre></div><p>这个实现的点就在于创建了一个阻塞的 chan: <code>ctx.done()</code>，然后使用<code>ctx.cancel()</code>将<code>ctx.done</code>设置为非阻塞(close)</p><h4 id=如何使用-withcancel>如何使用 WithCancel</h4><p>下面这段代码中，gen 函数死循环做 n++然后赋给 dst，dst 是一个 channel，可以通过 range 循环获取。即下面这段代码在<code>for n := range gen(ctx)</code>和<code>case dst &lt;- n: n++</code>之间循环了 5 次。</p><p>然后 main 函数退出，触发了 defer，执行 cancel。根据上面说的，cancel 会 close 掉 Done，所以<code>case &lt;-ctx.Done(): return</code>达到执行条件，gen 函数中创建的 goroutine<code>go func() { for { ... } }</code>执行结束</p><p>因为这个函数本身就只有这么一点点就退出了，所以看不出<code>WithCancel</code>的优点，不过，如果是大型引用，使用<code>WithCancel</code>可以及早释放一些不必要的 goroutine</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;context&#34;</span>
    <span style=color:#e6db74>&#34;fmt&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#75715e>// dst是一个channel，不停的遍历会递增
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>gen</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span> {
        <span style=color:#a6e22e>dst</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>)
        <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
            <span style=color:#66d9ef>for</span> {
                <span style=color:#66d9ef>select</span> {
                <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
                    <span style=color:#66d9ef>return</span> <span style=color:#75715e>// returning not to leak the goroutine
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>dst</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>n</span>:
                    <span style=color:#a6e22e>n</span><span style=color:#f92672>++</span>
                }
            }
        }()
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dst</span>
    }

    <span style=color:#75715e>// 创建ctx与cancel函数
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>() <span style=color:#75715e>// cancel when we are finished consuming integers
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// 遍历5次退出，执行defer
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>gen</span>(<span style=color:#a6e22e>ctx</span>) {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>n</span>)
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>5</span> {
            <span style=color:#66d9ef>break</span>
        }
    }
}

</code></pre></div><h4 id=withcancel-源码分析>WithCancel 源码分析</h4><p>生成一个 <code>cancelCtx{ }</code>，在 cancel 的时候会执行<code>func() { c.cancel(true, Canceled) }</code></p><p>看一下 propagateCancel 函数</p><ul><li>假如 parent 是 context.Background()，那么会执行到<code>else { go func() { .. } }</code><ul><li>这个时候，要么 parent 被 cancel 了，执行<code>case &lt;-parent.Done(): child.cancel(false, parent.Err())</code>，把本 ctxcancel 然后退出</li><li>要么等到了本 ctx 的 cancel：<code>case &lt;-child.Done()</code></li></ul></li><li>假如 parent 已经携带了控制信号<ul><li>parent 也是一个 cancelCtx，然后调用<code>func (c *cancelCtx) cancel(removeFromParent bool, err error)</code></li><li>parent 是一个 timerCtx，然后调用<code>func (c *timerCtx) cancel(removeFromParent bool, err error)s</code></li><li>（当然这里也可能是一个 valueCtx，这里会递归找下去）</li><li>children 是怎么使用的？</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#a6e22e>CancelFunc</span>) {
    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newCancelCtx</span>(<span style=color:#a6e22e>parent</span>)
    <span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>)
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>) }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>child</span> <span style=color:#a6e22e>canceler</span>) {
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#66d9ef>return</span> <span style=color:#75715e>// parent is never canceled
</span><span style=color:#75715e></span>    }
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parentCancelCtx</span>(<span style=color:#a6e22e>parent</span>); <span style=color:#a6e22e>ok</span> {
        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#75715e>// parent has already been canceled
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span>)
        } <span style=color:#66d9ef>else</span> {
            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
                <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>canceler</span>]<span style=color:#66d9ef>struct</span>{})
            }
            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>children</span>[<span style=color:#a6e22e>child</span>] = <span style=color:#66d9ef>struct</span>{}{}
        }
        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
    } <span style=color:#66d9ef>else</span> {
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
            <span style=color:#66d9ef>select</span> {
            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Done</span>():
                <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Err</span>())
            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>Done</span>():
            }
        }()
    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parentCancelCtx</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>, <span style=color:#66d9ef>bool</span>) {
    <span style=color:#66d9ef>for</span> {
        <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.(<span style=color:#66d9ef>type</span>) {
        <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cancelCtx</span>:
            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>true</span>
        <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>timerCtx</span>:
            <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>, <span style=color:#66d9ef>true</span>
        <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>valueCtx</span>:
            <span style=color:#a6e22e>parent</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>
        <span style=color:#66d9ef>default</span>:
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>
        }
    }
}
</code></pre></div><h3 id=然后看看-timerctx-是如何实现-cancel-的>然后看看 timerCtx 是如何实现 cancel 的</h3><h4 id=timerctx-源码解析>timerCtx 源码解析</h4><p>cancel 有两个实现，一个是 cancelCtx 的，一个是 TimerCtx 的</p><p>这里的 timerCtx 的 cancel 的逻辑是</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>timerCtx</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>cancelCtx</span>
    <span style=color:#a6e22e>timer</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Timer</span> <span style=color:#75715e>// Under cancelCtx.mu.
</span><span style=color:#75715e></span>
    <span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
}

<span style=color:#75715e>// 返回当前ctx的deadline
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>timerCtx</span>) <span style=color:#a6e22e>Deadline</span>() (<span style=color:#a6e22e>deadline</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>deadline</span>, <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>timerCtx</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v.WithDeadline(%s [%s])&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>deadline</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>deadline</span>))
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>timerCtx</span>) <span style=color:#a6e22e>cancel</span>(<span style=color:#a6e22e>removeFromParent</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>err</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>removeFromParent</span> {
        <span style=color:#75715e>// Remove this timerCtx from its parent cancelCtx&#39;s children.
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>removeChild</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancelCtx</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>c</span>)
    }
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#66d9ef>nil</span>
    }
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
}
</code></pre></div><h2 id=简析>简析</h2><h3 id=代码实现详解>代码实现详解</h3><h2 id=实现代码解析>实现代码解析</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// WithDeadline returns a copy of the parent context with the deadline adjusted
</span><span style=color:#75715e>// to be no later than d. If the parent&#39;s deadline is already earlier than d,
</span><span style=color:#75715e>// WithDeadline(parent, d) is semantically equivalent to parent. The returned
</span><span style=color:#75715e>// context&#39;s Done channel is closed when the deadline expires, when the returned
</span><span style=color:#75715e>// cancel function is called, or when the parent context&#39;s Done channel is
</span><span style=color:#75715e>// closed, whichever happens first.
</span><span style=color:#75715e>//
</span><span style=color:#75715e>// Canceling this context releases resources associated with it, so code should
</span><span style=color:#75715e>// call cancel as soon as the operations running in this Context complete.
</span><span style=color:#75715e></span><span style=color:#a6e22e>输入参数d是超时时间</span><span style=color:#960050;background-color:#1e0010>，</span>
<span style=color:#a6e22e>如果</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithDeadline</span>(<span style=color:#a6e22e>parent</span> <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>d</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) (<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>CancelFunc</span>) {
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cur</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>Deadline</span>(); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>cur</span>.<span style=color:#a6e22e>Before</span>(<span style=color:#a6e22e>d</span>) {
        <span style=color:#75715e>// The current deadline is already sooner than the new one.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>parent</span>)
    }
    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>timerCtx</span>{
        <span style=color:#a6e22e>cancelCtx</span>: <span style=color:#a6e22e>newCancelCtx</span>(<span style=color:#a6e22e>parent</span>),
        <span style=color:#a6e22e>deadline</span>:  <span style=color:#a6e22e>d</span>,
    }
    <span style=color:#a6e22e>propagateCancel</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>c</span>)
    <span style=color:#a6e22e>dur</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>d</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dur</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>DeadlineExceeded</span>) <span style=color:#75715e>// deadline has already passed
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>) }
    }
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>AfterFunc</span>(<span style=color:#a6e22e>dur</span>, <span style=color:#66d9ef>func</span>() {
            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>DeadlineExceeded</span>)
        })
    }
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Canceled</span>) }
}
</code></pre></div><h2 id=参考文章>参考文章</h2><ul><li><a href=https://github.com/grpc/grpc-go/issues/156>https://github.com/grpc/grpc-go/issues/156</a></li><li><a href=https://talks.golang.org/2014/gotham-context.slide#1>https://talks.golang.org/2014/gotham-context.slide#1</a></li></ul></div><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>© <a href=https://chyroc.cn>chyroc</a> <a href=https://github.com/spf13/hyde>Theme By hyde</a> 2020
<span id=reading-statistics><span><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'golang-context-ii',title:'Golang 中的 context 之控制（二）',owner:'chyroc',repo:'blog',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></main></body></html>