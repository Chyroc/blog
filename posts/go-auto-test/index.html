<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-cn lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>go 中的自动测试 &#183; Chyroc的博客</title><meta name=description content><link type=text/css rel=stylesheet href=https://chyroc.cn/css/print.css media=print><link type=text/css rel=stylesheet href=https://chyroc.cn/css/poole.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/syntax.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chyroc.cn><h1>Chyroc的博客</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chyroc.cn>Home</a></li><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul></nav></div></aside><main class="content container"><div class=post><h1>go 中的自动测试</h1><time datetime=2018-05-18T08:00:00+0800 class=post-date>2018-05-18 08:00:00</time><h2 id=前言>前言</h2><p>最近在做 leetcode 的题目，需要搞一些简单的测试代码，但是测试函数的输入输出的描述、判断函数是否成功比较麻烦</p><p>所以我就在想，能不能我定义一个 input 和一个 output，能够自动的将 input 转成 go 的代码，然后执行测试函数之后，比较返回值和 output 是否一致</p><p>要想这么做，肯定需要使用到反射，并且需要定义一下怎么从字符串转化到 go 的代码</p><h2 id=parse-字符串定义>parse 字符串定义</h2><ul><li>用逗号分隔数组的各个元素</li><li>用<code>\n</code>分隔多个输入或者多个输出</li><li><code>[1,2,3]</code> 定义 slice</li><li><code>{a: b}</code> 定义 map</li><li>slice 或者 map 中的子元素的类型要看函数定义参数的类型</li></ul><h2 id=代码解析>代码解析</h2><h3 id=parseparam-这里需要自定义-string-转化>parseParam 这里需要自定义 string 转化</h3><p>参数是<code>string</code> / <code>reflect.Type</code>，返回值是<code>reflect.Value</code></p><p>主要是<code>tring</code> to <code>int</code>,<code>bool</code>,<code>slice</code>,<code>map</code>，并转成<code>reflect.Value</code>的类型</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parseParam</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>param</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>typ</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>r</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span>
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>as</span> = <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
	<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>param</span>)

	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Kind</span>() {
	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Int</span>:
		<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>param</span>)
		<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>i</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>String</span>:
		<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>param</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Bool</span>:
		<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>ParseBool</span>(<span style=color:#a6e22e>param</span>)
		<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>b</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Slice</span>:
		<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>True</span>(len(<span style=color:#a6e22e>param</span>) &gt; <span style=color:#ae81ff>1</span>)
		<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>True</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>param</span>, <span style=color:#e6db74>&#34;[&#34;</span>))
		<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>True</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasSuffix</span>(<span style=color:#a6e22e>param</span>, <span style=color:#e6db74>&#34;]&#34;</span>))
		<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimPrefix</span>(<span style=color:#a6e22e>param</span>, <span style=color:#e6db74>&#34;[&#34;</span>)
		<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSuffix</span>(<span style=color:#a6e22e>param</span>, <span style=color:#e6db74>&#34;]&#34;</span>)
		<span style=color:#a6e22e>s2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>param</span>, <span style=color:#e6db74>&#34;,&#34;</span>)

		<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>MakeSlice</span>(<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>SliceOf</span>(<span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Elem</span>()), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s2</span> {
			<span style=color:#a6e22e>r</span> = <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>parseParam</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Elem</span>()))
		}
	<span style=color:#66d9ef>default</span>:
		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;not support %s&#34;</span>, <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Kind</span>()))
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>
}
</code></pre></div><h3 id=输入参数解析>输入参数解析</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ft</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#a6e22e>Func</span>)
<span style=color:#a6e22e>fv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>Func</span>)
</code></pre></div><p>然后遍历 reflect.TypeOf(Func).In(i)，这个是输入参数的类型</p><p>将输入参数字符串转成对应类型的 go 代码：ithParamIn := parseParam(t, input[i], ithCallInType)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>in</span> []<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span>
<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>NumIn</span>(); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
	<span style=color:#a6e22e>ithCallInType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>In</span>(<span style=color:#a6e22e>i</span>)

	<span style=color:#a6e22e>ithParamIn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseParam</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>input</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>ithCallInType</span>)

	<span style=color:#a6e22e>in</span> = append(<span style=color:#a6e22e>in</span>, <span style=color:#a6e22e>ithParamIn</span>)
}
</code></pre></div><h3 id=执行测试函数>执行测试函数</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fv</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>in</span>)
</code></pre></div><p>这边的 out 是一个[]reflect.Value，需要将他和函数签名，以及给定的输出的字符串进行比较</p><h3 id=输出参数解析和验证>输出参数解析和验证</h3><p>out 有三个，call 返回，ft.Out(i)的，output 的</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>NumOut</span>(); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
	<span style=color:#a6e22e>ithCallRealOut</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>out</span>[<span style=color:#a6e22e>i</span>] <span style=color:#75715e>// 比input多的
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ithCallOutType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>Out</span>(<span style=color:#a6e22e>i</span>)
	<span style=color:#a6e22e>ithCallOut</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseParam</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>output</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>ithCallOutType</span>)

	<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>ithCallOut</span>.<span style=color:#a6e22e>Kind</span>(), <span style=color:#a6e22e>ithCallRealOut</span>.<span style=color:#a6e22e>Kind</span>())
	<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>ithCallOut</span>.<span style=color:#a6e22e>Kind</span>(), <span style=color:#a6e22e>ithCallRealOut</span>.<span style=color:#a6e22e>Convert</span>(<span style=color:#a6e22e>ithCallOutType</span>).<span style=color:#a6e22e>Kind</span>())
	<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>ithCallOut</span>.<span style=color:#a6e22e>Interface</span>(), <span style=color:#a6e22e>ithCallRealOut</span>.<span style=color:#a6e22e>Convert</span>(<span style=color:#a6e22e>ithCallOutType</span>).<span style=color:#a6e22e>Interface</span>())
}
</code></pre></div><h2 id=所以看看这怎么用>所以看看这怎么用</h2><p>可以看到只要给了 input 和 output 的字符串，和要测试的函数，那么就能通过反射自动解析参数，执行测试代码，并看看是不是给定的输出</p><h2 id=代码地址1>代码（<a href=https://github.com/Chyroc/algorithms-go/blob/master/test/run_case.go>地址</a>）</h2></div><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>© <a href=https://chyroc.cn>chyroc</a> <a href=https://github.com/spf13/hyde>Theme By hyde</a> 2020
<span id=reading-statistics><span><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'go-auto-test',title:'go 中的自动测试',owner:'chyroc',repo:'blog',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></main></body></html>