<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-cn lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>golang 中的 testing 包介绍 &#183; Chyroc的博客</title><meta name=description content><link type=text/css rel=stylesheet href=https://chyroc.cn/css/print.css media=print><link type=text/css rel=stylesheet href=https://chyroc.cn/css/poole.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/syntax.css><link type=text/css rel=stylesheet href=https://chyroc.cn/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://chyroc.cn><h1>Chyroc的博客</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://chyroc.cn>Home</a></li><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul></nav></div></aside><main class="content container"><div class=post><h1>golang 中的 testing 包介绍</h1><time datetime=2018-05-15T08:00:00+0800 class=post-date>2018-05-15 08:00:00</time><p>testing 包是 go 中提供自动化测试的包，和命令 go test 配合使用，能够自动执行匹配到的函数。</p><h1 id=testxxx>TestXxx</h1><p>测试函数一般是这样的：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestXxx</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>)
</code></pre></div><p>测试函数需要满足一定的条件才能被执行，就像上面的那样，以<code>Test</code>开头，然后接一个以大写字母开头的单词，函数参数是<code>*testing.T</code></p><p>测试函数所在的文件也需要满足一定的条件：文件名需要以<code>_test.go</code>结尾，这样的文件在<code>go build</code>的时候不会包含，但是可以在<code>go test</code>的时候调用到</p><h1 id=benchmarkxxx>BenchmarkXxx</h1><p>其实还有一种测试函数：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkXxx</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>)
</code></pre></div><p>和上面那个<code>TestXxx</code>差不多，以<code>Benchmark</code>开头，并接一个大写字母开头的单词，函数参数是<code>*testing.B</code></p><p>这样的测试函数是压力测试函数，可以使用<code>go test</code>并且加上<code>-bench</code>参数的时候，被调用到</p><p>测试用例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkHello</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;hello&#34;</span>)
    }
}
</code></pre></div><p>压力测试函数必须运行 b.N 次目标代码，在压力测试函数运行期间，b.N 会动态的调整，直到基准测试功能持续足够长时间以可靠地计时为止</p><p>压力测试函数的输出类似于：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>BenchmarkHello    10000000    282 ns/op
</code></pre></div><p>这个的意思是压力测试函数以平均 282ns 每次的速度运行了 10000000 次</p><p>如果压力测试函数需要 setup 一些操作，那么需要调用一下<code>b.ResetTimer()</code>，示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkBigLen</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
    <span style=color:#a6e22e>big</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewBig</span>()
    <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ResetTimer</span>()
    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#a6e22e>big</span>.<span style=color:#a6e22e>Len</span>()
    }
}
</code></pre></div><p>如果压力测试需要测试并发，那么需要使用到<code>RunParallel</code>函数，示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkTemplateParallel</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
    <span style=color:#a6e22e>templ</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>Must</span>(<span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;test&#34;</span>).<span style=color:#a6e22e>Parse</span>(<span style=color:#e6db74>&#34;Hello, {{.}}!&#34;</span>))
    <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>RunParallel</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>PB</span>) {
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>Next</span>() {
            <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>Reset</span>()
            <span style=color:#a6e22e>templ</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#34;World&#34;</span>)
        }
    })
}
</code></pre></div><h1 id=examplexxx>ExampleXxx</h1><p>测试函数以<code>Example</code>开头，接一个大写字母开头的单词，没有函数参数；然后将函数内部以<code>// Output:</code>开头下面的注释和标准输出进行比较（忽略前后的空格）。</p><p>示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleSalutations</span>() {
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;hello, and&#34;</span>)
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;goodbye&#34;</span>)
    <span style=color:#75715e>// Output:
</span><span style=color:#75715e></span>    <span style=color:#75715e>// hello, and
</span><span style=color:#75715e></span>    <span style=color:#75715e>// goodbye
</span><span style=color:#75715e></span>}
</code></pre></div><p>有的时候输出是无需的，比如并发的时候，这个时候就需要使用<code>// Unordered output:</code>了：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExamplePerm</span>() {
    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>Perm</span>(<span style=color:#ae81ff>4</span>) {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>value</span>)
    }
    <span style=color:#75715e>// Unordered output: 4
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 0
</span><span style=color:#75715e></span>}
</code></pre></div><p>使用 Example 的时候有一些函数命名约定：函数 F，类型 T，类型 T 上面定义的方法 M</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Example</span>() { <span style=color:#f92672>...</span> }
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleF</span>() { <span style=color:#f92672>...</span> }
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleT</span>() { <span style=color:#f92672>...</span> }
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleT_M</span>() { <span style=color:#f92672>...</span> }
</code></pre></div><p>如果一个函数需要有多个 Example 函数，可以以下划线作为分割添加后缀</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Example_suffix</span>() { <span style=color:#f92672>...</span> }
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleF_suffix</span>() { <span style=color:#f92672>...</span> }
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleT_suffix</span>() { <span style=color:#f92672>...</span> }
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleT_M_suffix</span>() { <span style=color:#f92672>...</span> }
</code></pre></div><h1 id=子测试和子压力测试>子测试和子压力测试</h1><p><code>*testing.T</code>和<code>*testing.B</code>的 Run 方法允许定义子测试和子压力测试，而不需要定义两个测试</p><p>示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestFoo</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
    <span style=color:#75715e>// &lt;setup code&gt;
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;A=1&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) { <span style=color:#f92672>...</span> })
    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;A=2&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) { <span style=color:#f92672>...</span> })
    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;B=1&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) { <span style=color:#f92672>...</span> })
    <span style=color:#75715e>// &lt;tear-down code&gt;
</span><span style=color:#75715e></span>}
</code></pre></div><p>子测试的名字需要唯一，并且和主测试的名字以<code>/</code>连接</p><p>可以使用<code>-run</code>或者<code>-bench</code>参数为<code>go test</code>指定需要运行的测试代码</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>go test -run &#39;&#39;      # Run all tests.
go test -run Foo     # Run top-level tests matching &#34;Foo&#34;, such as &#34;TestFooBar&#34;.
go test -run Foo/A=  # For top-level tests matching &#34;Foo&#34;, run subtests matching &#34;A=&#34;.
go test -run /A=1    # For all top-level tests, run subtests matching &#34;A=1&#34;.
</code></pre></div><h1 id=主测试>主测试</h1><p>在有些测试中，需要在所有的测试之前做一些 setup，在所有的测试之后做一些 teardown，所以需要一个主测试来控制这些：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestMain</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>M</span>)
</code></pre></div><p>然后测试代码就不会直接运行了，而是会调用<code>TestMain</code></p><p>TestMain 会在主 goroutine 中运行，并做一些 setup 和 teardown，主测试需要调用<code>os.Exit(m.Run())</code></p><p>给一个例子吧：
<code>example_test.go</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>example</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;testing&#34;</span>
	<span style=color:#e6db74>&#34;os&#34;</span>
)

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestA</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Logf</span>(<span style=color:#e6db74>&#34;%s&#34;</span>, <span style=color:#a6e22e>s</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestMain</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>M</span>) {
	<span style=color:#a6e22e>s</span> = <span style=color:#e6db74>&#34;1&#34;</span>
	<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Run</span>())
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestB</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Logf</span>(<span style=color:#e6db74>&#34;%s&#34;</span>, <span style=color:#a6e22e>s</span>)
}
</code></pre></div><p><code>go test -v $(go list ./...)</code>
输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>=== RUN   TestA
--- PASS: TestA (0.00s)
	a_test.go:11: 1
=== RUN   TestB
--- PASS: TestB (0.00s)
	a_test.go:20: 1
PASS
</code></pre></div><p>可以看到<code>TestMain</code>初始化了变量 s，然后函数<code>TestMain</code>上面和下面的函数获取到的都是字符串 1</p><h1 id=参考>参考</h1><ul><li><a href=https://golang.org/pkg/testing/>godoc: Package testing</a></li></ul></div><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>© <a href=https://chyroc.cn>chyroc</a> <a href=https://github.com/spf13/hyde>Theme By hyde</a> 2020
<span id=reading-statistics><span><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'go-test-introduction',title:'golang 中的 testing 包介绍',owner:'chyroc',repo:'blog',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></main></body></html>